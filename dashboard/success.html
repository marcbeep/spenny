<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Success</title>
    <script src="api.js"></script>
  </head>
  <body>
    <h1>Success!</h1>
    <p id="userEmail"></p>
    <button onclick="logoutUser()">Logout</button>
    <img
      id="userProfilePicture"
      src=""
      alt="Profile Picture"
      style="width: 100px; height: 100px"
    />

    <ul id="analyticsList"></ul>

    <h1>Budget</h1>

    <!-- Display Ready to Assign -->
    <h3>Ready to Assign:</h3>
    <p id="readyToAssignValue">Loading...</p>

    <!-- Form to Assign Money to a Category -->
    <h3>Assign Money to Category</h3>
    <form id="assignMoneyForm">
      <input
        type="text"
        id="assignCategoryId"
        placeholder="Category ID"
        required
      />
      <input type="number" id="assignAmount" placeholder="Amount" required />
      <button type="submit">Assign Money</button>
    </form>

    <!-- Form to Move Money Between Categories -->
    <h3>Move Money Between Categories</h3>
    <form id="moveMoneyBetweenCategoriesForm">
      <input
        type="text"
        id="fromCategoryId"
        placeholder="From Category ID"
        required
      />
      <input
        type="text"
        id="toCategoryId"
        placeholder="To Category ID"
        required
      />
      <input type="number" id="moveCatAmount" placeholder="Amount" required />
      <button type="submit">Move Money</button>
    </form>

    <!-- Form to Remove Money from Category -->
    <h3>Remove Money from Category</h3>
    <form id="removeMoneyForm">
      <input
        type="text"
        id="removeCategoryId"
        placeholder="Category ID"
        required
      />
      <input type="number" id="removeAmount" placeholder="Amount" required />
      <button type="submit">Remove Money</button>
    </form>

    <!-- Form to Move Money to Ready to Assign -->
    <h3>Move Money to Ready to Assign</h3>
    <form id="moveToReadyToAssignForm">
      <input
        type="text"
        id="moveToReadyCategoryId"
        placeholder="Category ID"
        required
      />
      <input
        type="number"
        id="moveToReadyAmount"
        placeholder="Amount"
        required
      />
      <button type="submit">Move Money</button>
    </form>

    <h1>categories</h1>

    <h3>add new cat</h3>
    <form id="addCategoryForm">
      <input
        type="text"
        id="newCategoryTitle"
        placeholder="Category Title"
        required
      />
      <button type="submit">Add Category</button>
    </form>

<!-- Form to Delete a Category -->
<h3>Delete Category</h3>
<form id="deleteCategoryForm">
  <label for="deleteCategoryId">Category ID:</label>
  <input type="text" id="deleteCategoryId" name="deleteCategoryId" required />
  <label for="newCategoryId">New Category ID (for reassignment):</label>
  <input type="text" id="newCategoryId" name="newCategoryId" required />
  <button type="submit">Delete Category</button>
</form>


    <!-- Form to Update a Category -->
    <h3>update cat</h3>
    <form id="updateCategoryForm">
      <label for="updateCategoryId">Category ID:</label>
      <input
        type="text"
        id="updateCategoryId"
        name="updateCategoryId"
        required
      />

      <label for="updatedCategoryTitle">New Title:</label>
      <input
        type="text"
        id="updatedCategoryTitle"
        name="updatedCategoryTitle"
        required
      />

      <button type="submit">Update Category</button>
    </form>

    <h3>cat list</h3>
    <ul id="categoriesList"></ul>

    <h1>Goals</h1>

    <!-- Form to Create a Goal -->
    <h3>Create Goal</h3>
    <form id="createGoalForm">
      <input
        type="text"
        id="goalCategoryId"
        placeholder="Category ID"
        required
      />
      <select id="goalType" onchange="toggleResetDayVisibility();">
        <option value="saving">Savings</option>
        <option value="spending">Spending</option>
      </select>
      <input
        type="number"
        id="goalTarget"
        placeholder="Target Amount"
        required
      />
      <select id="goalResetDay" style="display: none">
        <option value="">Select Day</option>
        <option value="sunday">Sunday</option>
        <option value="monday">Monday</option>
        <option value="tuesday">Tuesday</option>
        <option value="wednesday">Wednesday</option>
        <option value="thursday">Thursday</option>
        <option value="friday">Friday</option>
        <option value="saturday">Saturday</option>
      </select>
      <button type="submit">Create Goal</button>
    </form>

    <script>
      function toggleResetDayVisibility() {
        var goalType = document.getElementById("goalType").value;
        var resetDayInput = document.getElementById("goalResetDay");
        if (goalType === "spending") {
          resetDayInput.style.display = "block";
          resetDayInput.required = true;
        } else {
          resetDayInput.style.display = "none";
          resetDayInput.required = false;
          resetDayInput.value = ""; // Clear value when not required
        }
      }
    </script>

    <!-- Form to Update a Goal -->
    <h3>Update Goal</h3>
    <form id="updateGoalForm">
      <input type="text" id="updateGoalId" placeholder="Goal ID" required />
      <input
        type="number"
        id="updateGoalTarget"
        placeholder="New Target Amount"
        required
      />
      <button type="submit">Update Goal</button>
    </form>

    <!-- Form to Delete a Goal -->
    <h3>Delete Goal</h3>
    <form id="deleteGoalForm">
      <input type="text" id="deleteGoalId" placeholder="Goal ID" required />
      <button type="submit">Delete Goal</button>
    </form>

    <!-- Display list of Goals -->
    <h3>Goal List</h3>
    <ul id="goalsList"></ul>

    <h1>accounts</h1>
    <h3>add account</h3>
    <form id="addAccountForm">
      <input
        type="text"
        id="accountTitle"
        placeholder="Account Title"
        required
      />
      <select id="accountType">
        <option value="spending">Spending</option>
        <option value="tracking">Tracking</option>
      </select>
      <input
        type="number"
        id="accountBalance"
        placeholder="Initial Balance"
        required
      />
      <button type="submit">Add Account</button>
    </form>

    <!-- Form to Update an Account -->
    <h3>update account balance</h3>
    <form id="updateAccountForm">
      <input
        type="text"
        id="updateAccountId"
        placeholder="Account ID"
        required
      />
      <input
        type="number"
        id="updateAccountBalance"
        placeholder="New Balance"
        required
      />
      <button type="submit">Update Balance</button>
    </form>

    <!-- Form to Archive an Account -->
    <h3>archive account</h3>
    <form id="archiveAccountForm">
      <input
        type="text"
        id="archiveAccountId"
        placeholder="Account ID"
        required
      />
      <button type="submit">Archive Account</button>
    </form>

    <!-- Form to Move Money Between Accounts -->
    <h3>move money between accounts</h3>
    <form id="moveMoneyForm">
      <input
        type="text"
        id="fromAccountId"
        placeholder="From Account ID"
        required
      />
      <input
        type="text"
        id="toAccountId"
        placeholder="To Account ID"
        required
      />
      <input type="number" id="moveAmount" placeholder="Amount" required />
      <button type="submit">Move Money</button>
    </form>

    <h3>account list</h3>
    <ul id="accountsList"></ul>

    <h1>transactions</h1>
    <h3>add new trans</h3>
    <form id="addTransactionForm">
      <input
        type="text"
        id="transactionTitle"
        placeholder="Transaction Title"
        required
      />
      <select id="transactionType">
        <option value="debit">Debit</option>
        <option value="credit">Credit</option>
      </select>
      <input
        type="number"
        id="transactionAmount"
        placeholder="Amount"
        required
      />
      <input
        type="text"
        id="transactionCategory"
        placeholder="Category ID"
        required
      />
      <input
        type="text"
        id="transactionAccount"
        placeholder="Account ID"
        required
      />
      <button type="submit">Add Transaction</button>
    </form>

    <h3>delete trans</h3>
    <form id="deleteTransactionForm">
      <input
        type="text"
        id="deleteTransactionId"
        placeholder="Transaction ID"
        required
      />
      <button type="submit">Delete Transaction</button>
    </form>

    <h3>Update Transaction Amount</h3>
<form id="updateTransactionForm">
  <input type="text" id="updateTransactionId" placeholder="Transaction ID" required />
  <input type="number" id="updateTransactionAmount" placeholder="New Amount" required />
  <button type="submit">Update Amount</button>
</form>


    <h3>trans list</h3>
    <ul id="transactionsList"></ul>

    <script>
      const userEmail = sessionStorage.getItem("userEmail");
      const userProfilePicture = sessionStorage.getItem("userProfilePicture");

      if (!userEmail || !userProfilePicture) {
        window.location.href = "index.html";
      } else {
        document.getElementById(
          "userEmail",
        ).textContent = `Email: ${userEmail}`;
        document.getElementById("userProfilePicture").src = userProfilePicture;
      }

      // BUDGET RELATED FUNCTIONS
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await displayReadyToAssign();
        } catch (error) {
          console.error("Failed to fetch Ready to Assign:", error);
          document.getElementById("readyToAssignValue").textContent =
            "Error fetching data";
        }
      });

      async function displayReadyToAssign() {
        const result = await fetchReadyToAssign();
        if (result && result.readyToAssign !== undefined) {
          document.getElementById(
            "readyToAssignValue",
          ).textContent = `£${result.readyToAssign}`;
        } else {
          throw new Error("Ready to Assign data is not available");
        }
      }

      document
        .getElementById("assignMoneyForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const categoryId = document
            .getElementById("assignCategoryId")
            .value.trim();
          const amount = parseFloat(
            document.getElementById("assignAmount").value,
          );
          try {
            await assignMoneyToCategory(categoryId, amount);
          } catch (error) {
            alert("Error assigning money: " + error.message);
          }
        });

      document
        .getElementById("moveMoneyBetweenCategoriesForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const fromCategoryId = document
            .getElementById("fromCategoryId")
            .value.trim();
          const toCategoryId = document
            .getElementById("toCategoryId")
            .value.trim();
          const amount = parseFloat(
            document.getElementById("moveCatAmount").value,
          );
          try {
            await moveMoneyBetweenCategories(
              fromCategoryId,
              toCategoryId,
              amount,
            );
          } catch (error) {
            alert("Error moving money between categories: " + error.message);
          }
        });

      document
        .getElementById("removeMoneyForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const categoryId = document
            .getElementById("removeCategoryId")
            .value.trim();
          const amount = parseFloat(
            document.getElementById("removeAmount").value,
          );
          try {
            await removeMoneyFromCategory(categoryId, amount);
          } catch (error) {
            alert("Error removing money from category: " + error.message);
          }
        });

      document
        .getElementById("moveToReadyToAssignForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const categoryId = document
            .getElementById("moveToReadyCategoryId")
            .value.trim();
          const amount = parseFloat(
            document.getElementById("moveToReadyAmount").value,
          );
          try {
            await moveToReadyToAssign(categoryId, amount);
          } catch (error) {
            alert("Error moving money to Ready to Assign: " + error.message);
          }
        });

      // CATEGORIES RELATED FUNCTIONS
      // add category
      document
        .getElementById("addCategoryForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const categoryTitle = document
            .getElementById("newCategoryTitle")
            .value.trim();
          if (categoryTitle) {
            await addCategory(categoryTitle);
            document.getElementById("newCategoryTitle").value = ""; // Clear the input field
          }
        });

      // Delete category
document.getElementById("deleteCategoryForm").addEventListener("submit", async function (event) {
  event.preventDefault();
  const categoryId = document.getElementById("deleteCategoryId").value.trim();
  const newCategoryId = document.getElementById("newCategoryId").value.trim();

  if (!categoryId || !newCategoryId) {
    alert("Both Category ID and New Category ID are required.");
    return;
  }

  try {
    await deleteCategory(categoryId, newCategoryId);
    alert(`Category ${categoryId} deleted and reassigned to ${newCategoryId}.`);
  } catch (error) {
    alert("Error deleting category: " + error.message);
  }
});

// update category
document.getElementById("updateCategoryForm").addEventListener("submit", async function (event) {
  event.preventDefault();
  const categoryIdElement = document.getElementById("updateCategoryId");
  const newTitleElement = document.getElementById("updatedCategoryTitle");

  console.log("Category ID Element:", categoryIdElement);
  console.log("New Title Element:", newTitleElement);

  const categoryId = categoryIdElement.value.trim();
  const newTitle = newTitleElement.value.trim();

  console.log("Category ID:", categoryId);
  console.log("New Title:", newTitle);

  try {
    await updateCategory(categoryId, newTitle);
  } catch (error) {
    console.error("Error updating category:", error);
    alert("Error updating category: " + error.message);
  }
});


      // GOALS RELATED FUNCTIONS
      document.addEventListener("DOMContentLoaded", async () => {
        await displayGoals(); // New function to display goals
      });

      async function displayGoals() {
        try {
          const goals = await fetchAllGoals();
          displayList(
            "goalsList",
            goals,
            (goal) =>
              `${goal._id} / ${goal.goalTitle} / cat: £${goal.goalCategory} / type: £${goal.goalType} / target: £${goal.goalTarget} / status: £${goal.goalStatus} / reset: ${goal.goalResetDay}`,
          );
        } catch (error) {
          console.error("Failed to fetch goals:", error);
          document.getElementById("goalsList").innerHTML =
            "<li>Error fetching goals.</li>";
        }
      }

      document
        .getElementById("createGoalForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const categoryId = document
            .getElementById("goalCategoryId")
            .value.trim();
          const goalType = document.getElementById("goalType").value;
          const goalTarget = parseFloat(
            document.getElementById("goalTarget").value,
          );
          let goalResetDay = document.getElementById("goalResetDay").value;

          // Prepare the body with mandatory fields
          const body = { categoryId, goalType, goalTarget };

          // Only add goalResetDay if the goal type is 'spending' and it's not empty
          if (goalType === "spending" && goalResetDay !== "") {
            body.goalResetDay = goalResetDay;
          } else {
            body.goalResetDay = ""; // Ensure goalResetDay is null if not applicable
          }

          console.log(body);
          try {
            await createGoal(
              categoryId,
              goalType,
              goalTarget,
              body.goalResetDay,
            );
          } catch (error) {
            alert("Error creating goal: " + error.message);
          }
        });

      document
        .getElementById("updateGoalForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const goalId = document.getElementById("updateGoalId").value.trim();
          const goalTarget = parseFloat(
            document.getElementById("updateGoalTarget").value,
          );
          console.log(goalId, goalTarget);
          try {
            await updateGoal(goalId, { goalTarget }); // Updated to match new backend expectations
          } catch (error) {
            alert("Error updating goal: " + error.message);
          }
        });

      document
        .getElementById("deleteGoalForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const goalId = document.getElementById("deleteGoalId").value.trim();
          try {
            await deleteGoal(goalId);
          } catch (error) {
            alert("Error deleting goal: " + error.message);
          }
        });

      // ACCOUNTS RELATED FUNCTIONS
      // add account
      document
        .getElementById("addAccountForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const accountTitle = document
            .getElementById("accountTitle")
            .value.trim();
          const accountType = document.getElementById("accountType").value;
          const accountBalance = parseFloat(
            document.getElementById("accountBalance").value,
          );
          if (accountTitle && accountType && !isNaN(accountBalance)) {
            await addAccount({ accountTitle, accountType, accountBalance });
            document.getElementById("accountTitle").value = "";
            document.getElementById("accountBalance").value = "";
          }
        });

      // Update an Account Balance
      document
        .getElementById("updateAccountForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const accountId = document
            .getElementById("updateAccountId")
            .value.trim();
          const accountBalance = parseFloat(
            document.getElementById("updateAccountBalance").value,
          );

          // Ensure data is valid before sending the request
          if (!isNaN(accountBalance)) {
            try {
              console.log(typeof accountBalance, accountBalance);
              await updateAccount(accountId, accountBalance);
            } catch (error) {
              alert("Error updating account balance: " + error.message);
            }
          } else {
            alert("Please enter a valid balance.");
          }
        });

      // Archive an Account
      document
        .getElementById("archiveAccountForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const accountId = document
            .getElementById("archiveAccountId")
            .value.trim();
          try {
            await archiveAccount(accountId);
          } catch (error) {
            alert("Error archiving account: " + error.message);
          }
        });

      // Move Money Between Accounts
      document
        .getElementById("moveMoneyForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const fromAccountId = document
            .getElementById("fromAccountId")
            .value.trim();
          const toAccountId = document
            .getElementById("toAccountId")
            .value.trim();
          const amount = parseFloat(
            document.getElementById("moveAmount").value,
          );

          if (!isNaN(amount)) {
            try {
              await moveMoneyBetweenAccounts(
                fromAccountId,
                toAccountId,
                amount,
              );
            } catch (error) {
              alert("Error moving money: " + error.message);
            }
          } else {
            alert("Please enter a valid amount.");
          }
        });

      // TRANSACTIONS RELATED FUNCTIONS
      // add transaction
      document
        .getElementById("addTransactionForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const transactionTitle = document
            .getElementById("transactionTitle")
            .value.trim();
          const transactionType =
            document.getElementById("transactionType").value;
          const transactionAmount = parseFloat(
            document.getElementById("transactionAmount").value,
          );
          const transactionCategory = document.getElementById(
            "transactionCategory",
          ).value;
          const transactionAccount =
            document.getElementById("transactionAccount").value;
          if (
            transactionTitle &&
            transactionType &&
            !isNaN(transactionAmount) &&
            transactionCategory &&
            transactionAccount
          ) {
            await createTransaction({
              transactionTitle,
              transactionType,
              transactionAmount,
              transactionCategory,
              transactionAccount,
            });
            document.getElementById("transactionTitle").value = "";
            document.getElementById("transactionAmount").value = "";
            document.getElementById("transactionCategory").value = "";
            document.getElementById("transactionAccount").value = "";
          }
        });

      // Delete a Transaction
      document
        .getElementById("deleteTransactionForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const transactionId = document
            .getElementById("deleteTransactionId")
            .value.trim();
          if (transactionId) {
            await deleteTransaction(transactionId);
            document.getElementById("deleteTransactionId").value = ""; // Clear the input field after deletion
            fetchAllTransactions(); // Refresh the transaction list
          }
        });

      // Update a Transaction Amount
document.getElementById("updateTransactionForm").addEventListener("submit", async (event) => {
  event.preventDefault();
  const transactionId = document.getElementById("updateTransactionId").value.trim();
  const transactionAmount = parseFloat(document.getElementById("updateTransactionAmount").value);

  if (!transactionId || isNaN(transactionAmount)) {
    alert("Please provide a valid Transaction ID and Amount.");
    return;
  }

  try {
    await updateTransaction(transactionId, { transactionAmount });
    document.getElementById("updateTransactionId").value = "";
    document.getElementById("updateTransactionAmount").value = "";
    updateUI(); // Assuming this function refreshes the UI including transaction list
  } catch (error) {
    alert("Error updating transaction amount: " + error.message);
  }
});

      document.addEventListener("DOMContentLoaded", () => {
        updateUI();
      });
    </script>
  </body>
</html>
